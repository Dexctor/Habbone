
'use client';

import { useEffect, useMemo, useState } from 'react';
import { ProfileHeaderCard } from './modules/ProfileHeaderCard';
import { ProfileInfoList } from './modules/ProfileInfoList';
import { ProfileSection } from './modules/ProfileSection';
import { ProfileTabs } from './modules/ProfileTabs';
import { ScrollArea } from '@/components/ui/scroll-area';
import { Card } from '@/components/ui/card';
import { BadgeIcon } from './modules/BadgeIcon';

type HabboProfileResponse = {
  user: any;
  profile: any | null;
  friends: any[];
  groups: any[];
  rooms: any[];
  badges: any[];
  uniqueId: string;
  achievements?: any[];
  achievementsCount?: number;
  achievementsTotalCount?: number;
};

const PAGE_SIZE = 100;
const HABBO_BASE = process.env.NEXT_PUBLIC_HABBO_BASE || 'https://www.habbo.fr';

// UI moved to modules/* components; logic below unchanged

export default function ProfileClient({ nick }: { nick: string }) {
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);
  const [data, setData] = useState<HabboProfileResponse | null>(null);

  const [friendsPage, setFriendsPage] = useState(1);
  const [groupsPage, setGroupsPage] = useState(1);
  const [badgesPage, setBadgesPage] = useState(1);
  const [roomsPage, setRoomsPage] = useState(1);

  useEffect(() => {
    let mounted = true;
    setLoading(true);
    setError(null);
    setData(null);

    const fetchData = async () => {
      try {
        const res = await fetch(`/api/habbo/profile?name=${encodeURIComponent(nick)}`, {
          cache: 'no-store',
        });
        const json = (await res.json()) as HabboProfileResponse | { error: string };
        if (!res.ok) {
          throw new Error((json as any)?.error || 'Erreur de rÃ©cupÃ©ration du profil');
        }
        if (mounted) setData(json as HabboProfileResponse);
      } catch (e: any) {
        if (mounted) setError(e?.message || 'Erreur');
      } finally {
        if (mounted) setLoading(false);
      }
    };

    fetchData();

    return () => {
      mounted = false;
    };
  }, [nick]);

  // Broadcast profile data to the header (mutualize on /profile)
  useEffect(() => {
    if (typeof window === 'undefined' || !data) return;
    try {
      (window as any).__habboProfile = data;
      const lvl = (data?.user?.currentLevel ?? (data as any)?.profile?.currentLevel ?? null);
      (window as any).__habboLevel = typeof lvl === 'number' ? lvl : null;
      window.dispatchEvent(new CustomEvent('habbo:profile', { detail: data }));
    } catch {}
  }, [data]);

  const counts = useMemo(() => {
    const achCount = typeof (data as any)?.achievementsCount === 'number'
      ? (data as any).achievementsCount
      : (Array.isArray(data?.achievements) ? data!.achievements!.length : 0)
    const achTotal = typeof (data as any)?.achievementsTotalCount === 'number'
      ? (data as any).achievementsTotalCount
      : undefined
    return {
      friends: data?.friends?.length ?? 0,
      groups: data?.groups?.length ?? 0,
      badges: data?.badges?.length ?? 0,
      rooms: data?.rooms?.length ?? 0,
      achievements: achCount,
      achievementsTotal: achTotal,
    } as const;
  }, [data]);

  const friendsVisible = useMemo(
    () => (data?.friends ?? []).slice(0, friendsPage * PAGE_SIZE),
    [data, friendsPage]
  );
  const groupsVisible = useMemo(
    () => (data?.groups ?? []).slice(0, groupsPage * PAGE_SIZE),
    [data, groupsPage]
  );
  const badgesVisible = useMemo(
    () => (data?.badges ?? []).slice(0, badgesPage * PAGE_SIZE),
    [data, badgesPage]
  );
  const roomsVisible = useMemo(
    () => (data?.rooms ?? []).slice(0, roomsPage * PAGE_SIZE),
    [data, roomsPage]
  );

  function fmtMemberSince(v?: string) {
    if (!v) return '';
    // Normalize timezone like +0000 -> +00:00 for Date parsing
    const norm = v.replace(/([+-]\\d{2})(\\d{2})$/, '$1:$2');
    const d = new Date(norm);
    return isNaN(+d) ? v : d.toLocaleDateString();
  }

  return (
    <div className="space-y-6" aria-busy={loading} aria-live="polite">
      {loading && <div className="text-sm opacity-80">Chargementâ€¦</div>}
      {error && (
        <div className="text-sm text-red-600 border border-red-600/30 rounded p-3 bg-red-600/10">
          {error}
        </div>
      )}

      {data && (
        <div className="grid grid-cols-12 gap-6">
          <div className="col-span-12 md:col-span-4 space-y-4">
            <ProfileHeaderCard
              nick={data.user?.name || ''}
              memberSince={fmtMemberSince(data.user?.memberSince || (data as any)?.profile?.memberSince)}
              level={typeof data.user?.currentLevel === 'number' ? data.user.currentLevel : undefined}
              starGems={typeof data.user?.starGemCount === 'number' ? data.user.starGemCount : undefined}
              avatarUrl={`${HABBO_BASE}/habbo-imaging/avatarimage?user=${encodeURIComponent(data.user?.name || '')}&direction=2&head_direction=3&img_format=png&gesture=sml&size=b`}
              motto={data.user?.motto}
              ariaBusy={loading}
            />
            <ProfileInfoList
              stats={{ topics: 0, comments: 0, articles: 0, coins: 0, friends: counts.friends, groups: counts.groups, badges: counts.badges }}
              rankings={[
                { label: 'Achievements top 250', value: '#18 (1639)' },
                { label: 'Badge top 250', value: '#48 (2296)' },
                { label: 'Unique badge top 50', value: '#19 (350)' },
                { label: 'Star Gems top 250', value: '#19 (155,115)' },
              ]}
            />
          </div>
          <div className="col-span-12 md:col-span-8 space-y-6">
            <ProfileSection title="Sujets postés">
              <div className="rounded-md bg-muted/40 p-4 text-center font-semibold text-destructive">Pas d'articles</div>
            </ProfileSection>

            <ProfileSection title="Articles postés">
              <div className="rounded-md bg-muted/40 p-4 text-center font-semibold text-destructive">Pas d'nouvelles</div>
            </ProfileSection>

            <ProfileTabs
              friendsSlot={(
                <>
                  <ScrollArea className="max-h-72">
                    <ul className="grid grid-cols-1 sm:grid-cols-2 gap-3">
                      {friendsVisible.map((f: any, idx) => (
                        <li key={f?.uniqueId || f?.name || idx} className="flex items-center gap-3 border rounded p-2">
                          {/* eslint-disable-next-line @next/next/no-img-element */}
                          <img
                            src={`${HABBO_BASE}/habbo-imaging/avatarimage?user=${encodeURIComponent(f?.name || f?.habbo || '')}&direction=2&head_direction=3&img_format=png&size=m`}
                            alt={f?.name || ''}
                            className="w-10 h-10 rounded"
                          />
                          <div className="min-w-0">
                            <div className="font-medium truncate">{f?.name || '–'}</div>
                            {f?.motto && (
                              <div className="text-xs opacity-70 truncate">{f.motto}</div>
                            )}
                          </div>
                        </li>
                      ))}
                    </ul>
                  </ScrollArea>
                  {counts.friends > friendsVisible.length && (
                    <button
                      className="mt-2 rounded px-3 py-1 border hover:bg-white hover:text-black focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-offset-2"
                      onClick={() => setFriendsPage((p) => p + 1)}
                    >
                      Charger +{Math.min(PAGE_SIZE, counts.friends - friendsVisible.length)}
                    </button>
                  )}
                </>
              )}
              groupsSlot={(
                <>
                  <ScrollArea className="max-h-72">
                    <ul className="space-y-3">
                      {groupsVisible.map((g: any, idx) => (
                        <li key={g?.id || g?.groupId || idx} className="border rounded p-2">
                          <div className="font-medium">{g?.name || '–'}</div>
                          {g?.description && (
                            <div className="text-xs opacity-70">{g.description}</div>
                          )}
                        </li>
                      ))}
                    </ul>
                  </ScrollArea>
                  {counts.groups > groupsVisible.length && (
                    <button
                      className="mt-2 rounded px-3 py-1 border hover:bg-white hover:text-black focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-offset-2"
                      onClick={() => setGroupsPage((p) => p + 1)}
                    >
                      Charger +{Math.min(PAGE_SIZE, counts.groups - groupsVisible.length)}
                    </button>
                  )}
                </>
              )}
              badgesSlot={(
                <>
                  <ScrollArea className="max-h-72">
                    <ul className="grid grid-cols-6 sm:grid-cols-10 gap-2">
                      {badgesVisible.map((b: any, idx) => {
                        const code = (b?.code || b?.badgeCode || '').trim();
                        return (
                          <li key={code || idx} className="flex flex-col items-center text-center">
                            <BadgeIcon code={code} />
                          </li>
                        );
                      })}
                    </ul>
                  </ScrollArea>
                  {counts.badges > badgesVisible.length && (
                    <button
                      className="mt-2 rounded px-3 py-1 border hover:bg-white hover:text-black focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-offset-2"
                      onClick={() => setBadgesPage((p) => p + 1)}
                    >
                      Charger +{Math.min(PAGE_SIZE, counts.badges - badgesVisible.length)}
                    </button>
                  )}
                </>
              )}
            />

            <ProfileSection title="Rooms">
              <ScrollArea className="max-h-72">
                <ul className="space-y-3">
                  {roomsVisible.map((r: any, idx) => (
                    <li key={r?.id || idx} className="border rounded p-2">
                      <div className="font-medium">{r?.name || '–'}</div>
                      {r?.description && (
                        <div className="text-xs opacity-70">{r.description}</div>
                      )}
                      {r?.creationTime && (
                        <div className="text-xs opacity-60 mt-1">
                          {new Date(r.creationTime).toLocaleString?.() || String(r.creationTime)}
                        </div>
                      )}
                    </li>
                  ))}
                </ul>
              </ScrollArea>
              {counts.rooms > roomsVisible.length && (
                <button
                  className="mt-2 rounded px-3 py-1 border hover:bg-white hover:text-black focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-offset-2"
                  onClick={() => setRoomsPage((p) => p + 1)}
                >
                  Charger +{Math.min(PAGE_SIZE, counts.rooms - roomsVisible.length)}
                </button>
              )}
            </ProfileSection>
          </div>
        </div>
      )}
    </div>
  );
}
